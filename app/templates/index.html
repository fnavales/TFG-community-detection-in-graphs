<!DOCTYPE html>
<html lang="es">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Titulo -->
        <title>Búsqueda de Comunidades | Fran Navarro</title>

        <!-- CSS locales -->
        <link href="../static/css//vis.min.css" rel="stylesheet" type="text/css"/>
        <link href="../static/css//vis-network.min.css" rel="stylesheet" type="text/css"/>
        <link href="../static/css//main.css" rel="stylesheet" type="text/css"/>

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    </head>

    <body>
        <nav class="navbar sticky-top navbar-toggleable-md navbar-inverse bg-inverse">
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <h1 class="navbar-brand mb-0">DetCom</h1>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/">Doc</a>
                    </li>
                </ul>
                <a href="load" class="btn btn-outline-success my-2 my-sm-0" role="button">Añadir Red</a>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <div class="col-9" id="mynetwork">

                </div>
                <div class="col-3">
                    <div class="row">
                        <label for="algGroup">Algoritmos</label>
                        <select class="custom-select" id="algGroup" onclick="updateIndex(value)">
                            <option selected value="-1" disabled>Elegir</option>
                            <option value="0" > Lovaina                           </option>
                            <option value="1" > Greedy -> Newman                  </option>
                            <option value="2" > Edge Betweenness -> Girvan-Newman </option>
                            <option value="3" > Label Propagation                 </option>
                        </select>
                    </div>

                    <div class="row">

                        <h4>Comunidades:</h4>
                        <pre id="communities"></pre>
                        <h4>Metadatos Nodo:</h4>
                        <pre id="nodeContent"></pre>
                    </div>


                </div>
            </div>
        </div>

        <!-- JS Local-->
        <script type="text/javascript" src="../static/js/vis.min.js"></script>
        <script type="text/javascript" src="../static/js/vis-network.min.js"></script>
        <script type="text/javascript" src="../static/js/gephiParser.js"></script>
        <script type="text/javascript" src="../static/js/exampleUtil.js"></script>

        <!-- JS BootStrap -->
        <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

        <!-- Funciones de Dibujo -->
        <script type="text/javascript">



        var network;

        var nodes = new vis.DataSet();
        var edges = new vis.DataSet();
        var gephiImported;
        var algGroup = document.getElementById('algGroup')

        var parsed = parseGephi({{json | tojson}},
            {
                fixed: false,
                parseColor: true
            }
        );

        nodes.add(parsed.nodes);
        edges.add(parsed.edges);


            function updateIndex(value) {
                if (value >= 0){
                    var ruta = "http://localhost:8080/alg/" + value;
                    window.location.replace(ruta);
                }
            }

        //    var fixedCheckbox = document.getElementById('fixed');
        //    fixedCheckbox.onchange = redrawAll;

        //    var parseColorCheckbox = document.getElementById('parseColor');
        //    parseColorCheckbox.onchange = redrawAll;

        var nodeContent = document.getElementById('nodeContent');
        var communitiesContent = document.getElementById('communities');

        //    loadJSON('../static/data/red'+selected+'.json', redrawAll, function (err) {
        //        console.log('error')
        //    });

        var container = document.getElementById('mynetwork');
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {
            nodes: {
                borderWidth: 1,
                shape: 'dot',
                scaling: {
                    min: 10,
                    max: 30,
                    label: {
                        min: 8,
                        max: 30,
                        drawThreshold: 12,
                        maxVisible: 20
                    }
                },
                font: {
                    size: 12,
                    face: 'Tahoma'
                }
            },
            edges: {
                width: 0.15,
                color: {inherit: 'from'},
                smooth: {
                    type: 'continuous'
                }
            },
            groups:{
                useDefaultGroups: true,
                com0: {color:{background:'rgb(20,20,255)'}},
                com1: {color:{background:'rgb(153,0,0)'}},
                com2: {color:{background:'rgb(153,0,153)'}},
                com3: {color:{background:'rgb(230,230,10)'}},
                com4: {color:{background:'rgb(153,77,0)'}},
                com5: {color:{background:'rgb(0,153,77)'}},
                com6: {color:{background:'rgb(0,153,0)'}},
                com7: {color:{background:'rgb(255,20,255)'}},
                com8: {color:{background:'rgb(20,20,20)'}},
                com9: {color:{background:'rgb(79,156,79)'}}
            },
            interaction: {
                tooltipDelay: 200,
                hideEdgesOnDrag: true
            },
            physics: {
                stabilization: false,
                barnesHut: {
                    gravitationalConstant: -4000,
                    springConstant: 0.001,
                    springLength: 200
                },
                forceAtlas2Based: {
                    gravitationalConstant: -26,
                    centralGravity: 0.005,
                    springLength: 230,
                    springConstant: 0.18
                },
                maxVelocity: 146,
                solver: 'barnesHut',
                timestep: 0.35,
                stabilization: {
                    enabled:true,
                    iterations:2000,
                    updateInterval:25
                }
            }
        };

        network = new vis.Network(container, data, options);
        network.fit();
        network.on('click', function (params) {
            if (params.nodes.length > 0) {
                var selectedNode = params.nodes[0];
                var data = nodes.get(selectedNode); // get the data from selected node
                nodeContent.innerHTML = JSON.stringify(data, undefined, 3); // show the data in the div
                var connectedNodes = network.getConnectedNodes(selectedNode);
    //            console.log(connectedNodes);
    //            nodes.update([{id:data['id'], hidden:true}]);

            }
        })

        {% if communities %}
            {% for c in communities %}

                nodes.update([{id:{{ loop.index }}, group:"com"+{{ c|int }}}]);
            {% endfor %}
            var data = nodes.get(108); // get the data from node 2 as example
            nodeContent.innerHTML = JSON.stringify(data, undefined, 3); // show the data in the div
            network.fit(); // zoom to fit
            setCommunityData();
        {% endif %}


        function getCommunityColor(element){
            return network["groups"]["groups"][element["group"]]["color"]["background"];
        }

        function setCommunityData() {
            var communities = [];

            nodes.forEach(function (element) {

                if (communities.includes(getCommunityColor(element))) {

                } else {
                    communities.push(getCommunityColor(element));
                }
            });
            var html = "";

            communities.forEach(function (c, i) {
               html += '<span style="background:'+c+'">&nbsp;&nbsp;</span> Comunidad '+ i +' <br><br>';
            });
            communitiesContent.innerHTML = html + "Número de comunidades: " + communities.length +
                "<br><br>Tiempo: "+ {{time}} + " ms<br><br>Modularidad: " + {{modularidad}};
        }
        /**
         * This function fills the DataSets. These DataSets will update the network.
         */
    //        function redrawAll() {
    //            if (gephiJSON.nodes === undefined) {
    //                gephiJSON = gephiImported;
    //            }
    //            else {
    //                gephiImported = gephiJSON;
    //            }
    //
    //            nodes.clear();
    //            edges.clear();

        //        var fixed = fixedCheckbox.checked;
        //        var parseColor = parseColorCheckbox.checked;

    //            var parsed = vis.network.gephiParser.parseGephi(gephiJSON, {
    //                fixed: false,
    //                parseColor: true
    //            });
    //
    //            // add the parsed data to the DataSets.
    //            nodes.add(parsed.nodes);
    //            edges.add(parsed.edges);

    //            var communities = [];
    //            nodes.forEach(function(element) {
    //
    //                if (communities.includes(element["color"])){
    //
    //                }else{
    //                    communities.push(element["color"]);
    //                }
    //            });
    //            console.log(communities);
    //            communitiesContent.innerHTML = "Número de comunidades: " + communities.length + "<br>Colores: " + communities;
    //
    //            var data = nodes.get(108); // get the data from node 2 as example
    //            nodeContent.innerHTML = JSON.stringify(data, undefined, 3); // show the data in the div
    //            network.fit(); // zoom to fit
    //        }

    </script>
    </body>
</html>