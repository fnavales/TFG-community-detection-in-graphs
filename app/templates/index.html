<!DOCTYPE html>
<html lang="es">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Titulo -->
        <title>Búsqueda de Comunidades | Fran Navarro</title>

        <!-- CSS locales -->
        <link href="../static/css//vis.min.css" rel="stylesheet" type="text/css"/>
        <link href="../static/css//vis-network.min.css" rel="stylesheet" type="text/css"/>
        <link href="../static/css//main.css" rel="stylesheet" type="text/css"/>

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    </head>

    <body>
        <nav class="navbar sticky-top navbar-toggleable-md navbar-inverse bg-inverse">
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <h1 class="navbar-brand mb-0">DetCom</h1>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/">Doc</a>
                    </li>
                </ul>
                <a href="load" class="btn btn-outline-success my-2 my-sm-0" role="button">Añadir Red</a>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <div class="col-9 top-buffer" id="mynetwork">

                </div>
                <div class="col-3">
                    <div class="top-buffer"></div>
                    <select class="custom-select" id="algGroup" onchange="updateIndex(value)">
                        <option selected  value="-1" disabled>Algoritmos</option>
                        <option  value="0" > Lovaina                           </option>
                        <option  value="1" > Greedy -> Newman                  </option>
                        <option  value="2" > Edge Betweenness -> Girvan-Newman </option>
                        <option  value="3" > Label Propagation                 </option>
                    </select>
                    <div id="accordion" role="tablist" aria-multiselectable="true">
                        <div class="card">
                            <div class="card-header" role="tab" id="headingOne">
                                <h5 class="mb-0">
                                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        Comunidades
                                    </a>
                                </h5>
                            </div>

                            <div id="collapseOne" class="collapse show" role="tabpanel" aria-labelledby="headingOne">
                                <div class="card-block">
                                    <pre id="communities"></pre>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header" role="tab" id="headingOne">
                                <h5 class="mb-0">
                                    <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        Metadatos Nodo
                                    </a>
                                </h5>
                            </div>

                            <div id="collapseTwo" class="collapse" role="tabpanel" aria-labelledby="headingTwo">
                                <div class="card-block">
                                    <pre id="nodeContent"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JS Local-->
        <script type="text/javascript" src="../static/js/vis.min.js"></script>
        <script type="text/javascript" src="../static/js/vis-network.min.js"></script>
        <script type="text/javascript" src="../static/js/gephiParser.js"></script>
        <script type="text/javascript" src="../static/js/exampleUtil.js"></script>

        <!-- JS BootStrap -->
        <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

        <!-- Funciones de Dibujo -->
        <script type="text/javascript">
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
            /** Atributos de la red **/
            var network;
            var allNodes;
            var highlightActive = false;

            /** Elementos Capturados **/
            var algGroup = document.getElementById('algGroup')
            var nodeContent = document.getElementById('nodeContent');
            var communitiesContent = document.getElementById('communities');
            communitiesContent.innerHTML = "Para ver datos seleccione un algortimo de la lista";

            /** Extraer nodos y enlaces **/
            var nodes = new vis.DataSet();
            var edges = new vis.DataSet();
//            loadJSON('../static/data/red'+selected+'.json', redrawAll, function (err) {
//                console.log('error')
//            });
            var parsed = parseGephi({{json | tojson}},
                {
                    fixed: false,
                    parseColor: true
                }
            );
            nodes.add(parsed.nodes);
            edges.add(parsed.edges);

            /** Petición para calcular comunidades **/
            function updateIndex(value) {

                if (value >= 0){
                    $.ajax({
                        type : 'POST',
                        url : $SCRIPT_ROOT + '/apply_alg/'+value,
                        success : function(data) {
                            var networkData = JSON.parse(data);
                            networkData["comunidades"].forEach(function (e,id) {
                                nodes.update([{id:id+1, group:parseInt(e)}]);
                            });
                            nodeContent.innerHTML = "Seleccione un nodo";
                            setCommunityData(networkData.tiempo,networkData.modularidad);
                            allNodes = nodes.get({returnType:"Object"});
                        }
                    });
                }
            }

            /** Pintar el grafo **/
            function redrawAll() {
                var container = document.getElementById('mynetwork');
                var data = {
                    nodes: nodes,
                    edges: edges
                };
                var options = {
                    nodes: {
                        borderWidth: 1,
                        shape: 'dot',
                        scaling: {
                            min: 10,
                            max: 30,
                            label: {
                                min: 8,
                                max: 30,
                                drawThreshold: 12,
                                maxVisible: 20
                            }
                        },
                        font: {
                            size: 12,
                            face: 'Tahoma'
                        }
                    },
                    edges: {
                        width: 0.15,
                        color: {inherit: 'from'},
                        smooth: {
                            type: 'continuous'
                        }
                    },
                    groups:{
                        useDefaultGroups: true
                    },
                    interaction: {
                        hideEdgesOnDrag: true,
                        multiselect: true
                    },

                    physics: {
                        stabilization: false,
                        barnesHut: {
                            gravitationalConstant: -4000,
                            springConstant: 0.001,
                            springLength: 200
                        },
                        forceAtlas2Based: {
                            gravitationalConstant: -26,
                            centralGravity: 0.005,
                            springLength: 230,
                            springConstant: 0.18
                        },
                        maxVelocity: 146,
                        solver: 'barnesHut',
                        timestep: 0.35,
                        stabilization: {
                            enabled:true,
                            iterations:2000,
                            updateInterval:25
                        }
                    }
                };
                network = new vis.Network(container, data, options);

                // Obtener copia de los nodos para marcar vecinos
                allNodes = nodes.get({returnType:"Object"});

                network.on("click",neighbourhoodHighlight);
        }

        function neighbourhoodHighlight(params) {
            // if something is selected:
            if (params.nodes.length > 0) {
                var selectedNode = params.nodes[0];
                var data = nodes.get(selectedNode); // get the data from selected node
                nodeContent.innerHTML = JSON.stringify(data, undefined, 3); // show the data in the div
                  highlightActive = true;
                  var i,j;
                  var degrees = 2;

                  // mark all nodes as hard to read.
                  for (var nodeId in allNodes) {
                    allNodes[nodeId].color = 'rgba(200,200,200,0.5)';
                    if (allNodes[nodeId].hiddenLabel === undefined) {
                      allNodes[nodeId].hiddenLabel = allNodes[nodeId].label;
                      allNodes[nodeId].label = undefined;
                    }
                  }
                  var connectedNodes = network.getConnectedNodes(selectedNode);
                  var allConnectedNodes = [];

                  // get the second degree nodes
                  for (i = 1; i < degrees; i++) {
                    for (j = 0; j < connectedNodes.length; j++) {
                      allConnectedNodes = allConnectedNodes.concat(network.getConnectedNodes(connectedNodes[j]));
                    }
                  }

                  // all second degree nodes get a different color and their label back
                  for (i = 0; i < allConnectedNodes.length; i++) {
                    allNodes[allConnectedNodes[i]].color = 'rgba(150,150,150,0.75)';
                    if (allNodes[allConnectedNodes[i]].hiddenLabel !== undefined) {
                      allNodes[allConnectedNodes[i]].label = allNodes[allConnectedNodes[i]].hiddenLabel;
                      allNodes[allConnectedNodes[i]].hiddenLabel = undefined;
                    }
                  }

                  // all first degree nodes get their own color and their label back
                  for (i = 0; i < connectedNodes.length; i++) {
                    allNodes[connectedNodes[i]].color = undefined;
                    if (allNodes[connectedNodes[i]].hiddenLabel !== undefined) {
                      allNodes[connectedNodes[i]].label = allNodes[connectedNodes[i]].hiddenLabel;
                      allNodes[connectedNodes[i]].hiddenLabel = undefined;
                    }
                  }

                  // the main node gets its own color and its label back.
                  allNodes[selectedNode].color = undefined;
                  if (allNodes[selectedNode].hiddenLabel !== undefined) {
                    allNodes[selectedNode].label = allNodes[selectedNode].hiddenLabel;
                    allNodes[selectedNode].hiddenLabel = undefined;
                  }
                }
            else if (highlightActive === true) {
                // reset all nodes
                for (var nodeId in allNodes) {
                    allNodes[nodeId].color = undefined;
                    if (allNodes[nodeId].hiddenLabel !== undefined) {
                        allNodes[nodeId].label = allNodes[nodeId].hiddenLabel;
                        allNodes[nodeId].hiddenLabel = undefined;
                    }
                }
                highlightActive = false;
            }

            // transform the object into an array
            var updateArray = [];
            for (nodeId in allNodes) {
              if (allNodes.hasOwnProperty(nodeId)) {
                updateArray.push(allNodes[nodeId]);
              }
            }
            nodes.update(updateArray);
          }





        redrawAll();
        function getCommunityColor(){
            return network["groups"]["groups"];
        }

        function enlacesInOut(nodo) {
            var connectedNodes = network.getConnectedNodes(nodo.id);
            var entrada = 0;
            var salida = 0;

            connectedNodes.forEach(function (e) {
                if (nodo.group === (nodes.get(e)).group) {
                    entrada++;
                }else {
                    salida++;
                }
            });
            nodes.update([{id:nodo.id, enlaces:{in:entrada, out:salida}}]);
            return {com: nodo.group,
                    enlaces: {
                    in: entrada,
                    out: salida}
            };
        }


        function setCommunityData(tiempo, modularidad) {
            var valoresCom = {};
            var colores = getCommunityColor();
            var numberOfCom = [];

            nodes.forEach(function (element) {
                if(numberOfCom.indexOf(element.group) < 0){
                    numberOfCom.push(element.group);
                }
                var aux = enlacesInOut(element);
                if (!valoresCom[aux.com]) {
                    valoresCom[aux.com] = aux.enlaces;
                }else{
                    valoresCom[aux.com].in += aux.enlaces.in;
                    valoresCom[aux.com].out += aux.enlaces.out;
                }

            });
            var html = "";

            Object.keys(colores).slice(0,numberOfCom.length).forEach(function(key, index) {
                var total = valoresCom[key].in + valoresCom[key].out;
                var dentro = (valoresCom[key].in/total)*100;
                var fuera = (valoresCom[key].out/total)*100;

                html += '<span style="background:' + this[key].color.background + '"><a onclick="selectNodesFromColor('+index+')">&nbsp;&nbsp;</a></span> Comunidad ' + index + ' (' + dentro.toPrecision(2) + '%, ' + fuera.toPrecision(2) + '%)<br>';

            }, colores);
//
            communitiesContent.innerHTML =  html +
                                            "<br>Tiempo: " + tiempo + " ms<br>" +
                                            "Modularidad: " + modularidad;
        }

        function selectNodesFromColor(ind) {
            var newNodes = (nodes.get()).filter(function (el) {
                  return el.group === (ind);
            }).map(function(el) {
                return el.id;
            }).sort();

//            network.selectNodes(newNodes);
            var options = {
                // position: {x:positionx,y:positiony}, // this is not relevant when focusing on nodes
                scale: 0.3,
                locked:true,
                animation: {
                  duration: 1000,
                  easingFunction: 'easeInQuad'
                }
            };
            network.focus(newNodes[Math.floor(Math.random()*newNodes.length)],options);
        }

    </script>
    </body>
</html>